services:
  can_bridge:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: mes1_can_bridge
    image: mes1_system:latest
    
    # Network mode: host is required for CAN interface access
    network_mode: host
    
    # Privileged mode and capabilities for CAN access
    privileged: true
    cap_add:
      - NET_ADMIN
      - SYS_ADMIN
    
    # Mount devices
    devices:
      - /dev/net/tun
    
    # Environment variables
    environment:
      - ROS_DOMAIN_ID=0
      - ROS_LOCALHOST_ONLY=0
      - CAN_INTERFACE=can0
      - CAN_BITRATE=1000000
      - NODE_ID=21
      - LOG_LEVEL=INFO
    
    # Volumes
    volumes:
      # Mount host's network namespace for CAN access
      - /sys/class/net:/sys/class/net:ro
      - /sys/devices:/sys/devices:ro
      # Optional: Mount config directory
      - ./config:/ros2_ws/src/mes1_system/config:ro
      # Optional: Mount logs directory
      - ./logs:/var/log/can_bridge
    
    # Restart policy
    restart: unless-stopped
    
    # Command - run socketcan bridge node directly
    command:
      - /ros2_ws/install/mes1_system/lib/ros_can_bridge_native/socketcan_bridge_node
      - --ros-args
      - -p
      - can_interface:=can0
      - -p
      - node_id:=21
      - -p
      - bitrate:=1000000
    
    # Health check
    healthcheck:
      test: ["CMD", "ros2", "node", "list"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Optional: Separate diagnostics viewer
  diagnostics_viewer:
    image: mes1_system:latest
    container_name: mes1_diagnostics
    network_mode: host
    environment:
      - ROS_DOMAIN_ID=0
      - ROS_LOCALHOST_ONLY=0
    command: ros2 topic echo /diagnostics
    depends_on:
      - can_bridge
    profiles:
      - debug

  # Optional: Interactive command client
  command_client:
    image: mes1_system:latest
    container_name: mes1_client
    network_mode: host
    stdin_open: true
    tty: true
    environment:
      - ROS_DOMAIN_ID=0
      - ROS_LOCALHOST_ONLY=0
    command: ros2 run mes1_system command_client
    depends_on:
      - can_bridge
    profiles:
      - interactive
